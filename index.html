<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOS TRADE: Real-time Roguelike</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Basic styling for the DOS terminal look */
        body {
            background-color: #000; /* Black background */
            color: #FFA500; /* Amber/Orange text, matching the reference image */
            font-family: 'Press Start 2P', monospace; /* Retro pixel font */
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center; /* Center content horizontally */
            align-items: flex-start; /* Align content to the top */
            min-height: 100vh; /* Full viewport height */
            overflow-y: auto; /* Allow vertical scrolling if content overflows */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        /* Main container for the entire game console */
        .container {
            width: 100%;
            max-width: 900px; /* Increased max-width for more content */
            border: 2px solid #FFA500; /* Amber border */
            padding: 15px;
            box-shadow: 0 0 10px rgba(255, 165, 0, 0.5); /* Subtle amber glow effect */
            border-radius: 5px; /* Slightly rounded corners */
            display: grid;
            /* Define grid rows: top-bar, main-content-grid, bottom-content-grid, input-area */
            grid-template-rows: auto 1fr auto auto;
            gap: 10px; /* Space between grid rows */
        }

        /* Top bar for FUNDS, TOTAL ASSETS, and TIME */
        #top-bar {
            display: flex;
            justify-content: space-between;
            padding-bottom: 5px;
            border-bottom: 1px solid #FFA500;
            font-size: 0.9em; /* Slightly smaller font for stats */
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        }
        #top-bar span {
            margin-right: 15px; /* Space between stats */
            margin-bottom: 5px; /* Space when wrapping */
        }
        #time-display {
            color: #FFD700; /* Gold color for time to stand out */
            font-weight: bold;
        }

        /* Grid for the main content area (Stock Table and Log) */
        .main-content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Stock table takes 2/3, log takes 1/3 */
            gap: 10px;
            height: 400px; /* Fixed height for this section */
            overflow: hidden; /* Hide overflow from children to manage scrolling within */
        }

        /* Container for the dynamically generated stock table */
        #stock-table-container {
            overflow-y: auto; /* Enable vertical scrolling for table content */
            border: 1px solid #FFA500;
            padding: 5px;
            box-sizing: border-box;
            font-size: 0.85em; /* Slightly smaller font for table data */
            line-height: 1.4;
            /* Custom scrollbar for retro look */
            scrollbar-width: thin;
            scrollbar-color: #FFA500 #333;
        }

        #stock-table-container::-webkit-scrollbar { width: 8px; }
        #stock-table-container::-webkit-scrollbar-track { background: #333; }
        #stock-table-container::-webkit-scrollbar-thumb { background-color: #FFA500; border-radius: 4px; border: 1px solid #000; }

        /* Styling for the stock table itself */
        #stock-table {
            width: 100%;
            border-collapse: collapse; /* Remove space between table cells */
        }

        #stock-table th, #stock-table td {
            padding: 4px 8px;
            text-align: left;
            border-bottom: 1px dashed rgba(255, 165, 0, 0.3); /* Dashed separator */
            white-space: nowrap; /* Prevent wrapping in table cells */
        }

        #stock-table th {
            color: #FFD700; /* Gold-like color for headers */
            font-weight: normal; /* Keep font weight normal for pixel font */
            padding-bottom: 8px;
        }

        /* Make table rows clickable and add hover effect */
        #stock-table tbody tr {
            cursor: pointer;
        }
        #stock-table tbody tr:hover {
            background-color: rgba(255, 165, 0, 0.1); /* Slight highlight on hover */
        }

        /* Price change indicators */
        .price-up {
            color: lime; /* Green for price increase */
            animation: flash-green 0.3s ease-out; /* Quick flash animation */
        }
        .price-down {
            color: red; /* Red for price decrease */
            animation: flash-red 0.3s ease-out; /* Quick flash animation */
        }

        @keyframes flash-green {
            0% { background-color: rgba(0, 255, 0, 0.3); }
            100% { background-color: transparent; }
        }
        @keyframes flash-red {
            0% { background-color: rgba(255, 0, 0, 0.3); }
            100% { background-color: transparent; }
        }


        /* Log area for game messages */
        #log-area {
            overflow-y: auto; /* Enable vertical scrolling for log messages */
            border: 1px solid #FFA500;
            padding: 5px;
            box-sizing: border-box;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            line-height: 1.3;
            font-size: 0.85em;
            /* Custom scrollbar */
            scrollbar-width: thin;
            scrollbar-color: #FFA500 #333;
        }

        #log-area::-webkit-scrollbar { width: 8px; }
        #log-area::-webkit-scrollbar-track { background: #333; }
        #log-area::-webkit-scrollbar-thumb { background-color: #FFA500; border-radius: 4px; border: 1px solid #000; }

        /* Grid for the bottom content area (Command History and Chart) */
        .bottom-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Command history and chart take equal halves */
            gap: 10px;
            height: 200px; /* Fixed height for this section */
            overflow: hidden;
        }

        /* Command history area */
        #command-history {
            overflow-y: auto; /* Enable vertical scrolling for command history */
            border: 1px solid #FFA500;
            padding: 5px;
            box-sizing: border-box;
            white-space: pre-wrap;
            line-height: 1.3;
            font-size: 0.85em;
            /* Custom scrollbar */
            scrollbar-width: thin;
            scrollbar-color: #FFA500 #333;
        }

        #command-history::-webkit-scrollbar { width: 8px; }
        #command-history::-webkit-scrollbar-track { background: #333; }
        #command-history::-webkit-scrollbar-thumb { background-color: #FFA500; border-radius: 4px; border: 1px solid #000; }


        /* Chart area */
        #chart-area {
            border: 1px solid #FFA500;
            padding: 5px;
            display: flex; /* Use flexbox to center canvas */
            flex-direction: column; /* Stack title and canvas vertically */
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
        }

        #chart-title {
            font-size: 0.8em;
            margin-bottom: 5px;
            text-align: center;
        }

        /* Canvas for the market chart */
        #market-chart {
            background-color: #000;
            width: 100%; /* Canvas fills its parent */
            height: 100%;
            display: block; /* Remove extra space below canvas */
        }

        /* Input area layout */
        #input-area {
            display: flex;
            align-items: center; /* Vertically align items */
            padding-top: 5px;
            border-top: 1px solid #FFA500;
        }

        #input-area label {
            margin-right: 10px;
            white-space: nowrap;
            font-size: 0.9em;
        }

        /* Styling for the command input field */
        #command-input {
            background-color: #000;
            color: #FFA500;
            border: 1px solid #FFA500;
            padding: 8px;
            flex-grow: 1; /* Allows input to take available space */
            font-family: 'Press Start 2P', monospace;
            font-size: 0.9em;
            border-radius: 3px;
            outline: none;
        }

        /* Styling for buttons */
        button {
            background-color: #FFA500; /* Amber background */
            color: #000; /* Black text */
            border: 1px solid #FFA500;
            padding: 8px 15px;
            margin-left: 10px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.8em; /* Slightly smaller font for buttons */
            border-radius: 3px;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: 2px 2px 5px rgba(255, 165, 0, 0.3); /* Amber shadow */
        }

        button:hover {
            background-color: #000; /* Invert colors on hover */
            color: #FFA500;
            box-shadow: 0 0 8px rgba(255, 165, 0, 0.7); /* More prominent glow */
        }

        button:active {
            transform: translateY(1px); /* Slight press effect */
            box-shadow: 1px 1px 3px rgba(255, 165, 0, 0.5);
        }

        /* --- New Styles for Menus and Buttons --- */

        /* Hidden class to toggle visibility */
        .hidden {
            display: none !important;
        }

        /* Main Menu Styling */
        #main-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh; /* Full viewport height for menu */
            text-align: center;
        }

        #main-menu h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            color: #FFD700; /* Gold for title */
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.7);
        }

        #main-menu button {
            width: 200px;
            margin-bottom: 15px;
            font-size: 1.2em;
            padding: 12px 20px;
        }

        /* Stock Action Buttons */
        #stock-action-buttons {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap */
            justify-content: center;
            padding: 10px 0;
            border-top: 1px solid #FFA500;
            margin-top: 10px;
            gap: 10px; /* Space between buttons */
        }
        #stock-action-buttons button {
            margin: 0; /* Override default button margin */
        }

        /* Game Over Screen */
        #game-over-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        #game-over-screen h1 {
            font-size: 2.2em;
            margin-bottom: 20px;
            color: #FFD700;
        }
        #game-over-screen p {
            font-size: 1.1em;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        #game-over-screen button {
            font-size: 1.1em;
            padding: 10px 20px;
        }

        /* --- Modal (Popup) Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
        }

        .modal-content {
            background-color: #000;
            border: 2px solid #FFA500;
            border-radius: 5px;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.8);
            text-align: left;
            position: relative;
            max-height: 80vh; /* Limit height for scrollability */
            overflow-y: auto; /* Enable scrolling for long content */
        }

        .modal-content h2 {
            color: #FFD700;
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px dashed rgba(255, 165, 0, 0.3);
            padding-bottom: 10px;
        }

        .modal-content p {
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 10px;
            white-space: pre-wrap; /* Preserve formatting for help text */
        }

        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #8B0000; /* Red for close */
            color: #FFD700; /* Gold for text */
            border: 1px solid #FFD700;
            padding: 5px 10px;
            font-size: 0.7em;
            cursor: pointer;
            border-radius: 3px;
            box-shadow: 1px 1px 3px rgba(255, 0, 0, 0.5);
        }
        .modal-close-button:hover {
            background-color: #FF0000;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.9);
        }


        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .main-content-grid, .bottom-content-grid {
                grid-template-columns: 1fr; /* Stack columns on small screens */
                height: auto; /* Allow height to adjust */
            }
            #stock-table-container, #log-area, #command-history, #chart-area {
                margin-bottom: 10px; /* Add space between stacked sections */
                height: 250px; /* Give some height when stacked */
            }
            #top-bar {
                flex-direction: column; /* Stack stats vertically */
                align-items: flex-start;
            }
            #top-bar span {
                margin-bottom: 5px;
            }
            #command-input, button {
                font-size: 0.75em;
                padding: 6px;
            }
            #input-area label {
                font-size: 0.75em;
            }
            #main-menu h1 {
                font-size: 1.8em;
            }
            #main-menu button {
                width: 180px;
                font-size: 1em;
            }
            #stock-action-buttons {
                flex-direction: column; /* Stack buy/sell buttons vertically */
            }
            #stock-action-buttons button {
                width: 90%; /* Make buttons wider when stacked */
                margin: 5px auto;
            }
            .modal-content {
                padding: 15px;
            }
            .modal-content h2 {
                font-size: 1.2em;
            }
            .modal-content p {
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 10px;
                border-width: 1px;
            }
            #stock-table th, #stock-table td {
                font-size: 0.7em;
                padding: 2px 4px;
            }
            #log-area, #command-history {
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div id="main-menu">
        <h1>DOS TRADE</h1>
        <button id="start-game-button">START GAME</button>
        <button id="main-menu-help-button">HELP</button>
    </div>

    <div id="game-screen" class="container hidden">
        <div id="top-bar">
            <span id="funds-display">FUNDS: $1000.00</span>
            <span id="assets-display">TOTAL ASSETS: $1000.00</span>
            <span id="time-display">TIME: 00:00</span>
        </div>

        <div class="main-content-grid">
            <div id="stock-table-container">
                </div>
            <div id="log-area">
                </div>
        </div>

        <div id="stock-action-buttons" class="hidden">
            <button id="buy-1-button">BUY 1</button>
            <button id="buy-10-button">BUY 10</button>
            <button id="buy-max-button">BUY MAX</button>
            <button id="sell-1-button">SELL 1</button>
            <button id="sell-10-button">SELL 10</button>
            <button id="sell-all-button">SELL ALL</button>
            <button id="panic-sell-all-button" style="background-color: #8B0000; color: #FFD700; border-color: #FFD700; box-shadow: 0 0 8px rgba(255, 0, 0, 0.7);">PANIC SELL ALL</button>
        </div>

        <div class="bottom-content-grid">
            <div id="command-history">
                </div>
            <div id="chart-area">
                <div id="chart-title">MARKET INDEX TREND</div>
                <canvas id="market-chart"></canvas>
            </div>
        </div>

        <div id="input-area">
            <label for="command-input">C:\DOS_TRADE&gt;</label>
            <input type="text" id="command-input" autofocus>
            <button id="enter-button">ENTER</button>
        </div>
    </div>

    <div id="game-over-screen" class="hidden">
        <h1>GAME OVER!</h1>
        <p id="game-over-message"></p>
        <button id="restart-game-button">RESTART GAME</button>
    </div>

    <div id="help-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="help-modal-close-button">X</button>
            <h2>GAME HELP</h2>
            <p id="help-modal-text"></p>
        </div>
    </div>

    <script type="module">
        // --- Game State Variables ---
        let playerMoney = 1000; // Starting capital for the player
        const targetMoney = 5000; // Financial goal to win the game

        const gameDurationSeconds = 180; // Total game duration in seconds (3 minutes)
        const gracePeriodSeconds = 5; // Changed: Grace period to 5 seconds
        let timeLeft = gameDurationSeconds + gracePeriodSeconds; // Total time including grace period
        let gameInterval; // To hold the setInterval ID for the game loop

        const updateIntervalMs = 1000; // How often prices and events update (1 second)
        const eventChancePerInterval = 0.1; // 10% chance of a major event per interval

        // Stock data: symbol, full name, current price, shares held, average buy price, volatility, and available shares
        // Added 'lastPrice' for visual feedback and 'history' array for trends.
        const stocks = {
            "WTK": { name: "MATER", price: 36, lastPrice: 36, held: 0, avgBuyPrice: 0, volatility: 0.08, availableShares: 153, history: [] },
            "PLS": { name: "PLASTICS", price: 161, lastPrice: 161, held: 0, avgBuyPrice: 0, volatility: 0.04, availableShares: 335, history: [] },
            "KQU": { name: "KUMQUATS", price: 348, lastPrice: 348, held: 0, avgBuyPrice: 0, volatility: 0.12, availableShares: 219, history: [] },
            "GOL": { name: "GOLD", price: 398, lastPrice: 398, held: 0, avgBuyPrice: 0, volatility: 0.06, availableShares: 129, history: [] },
            "OFS": { name: "OFFICE SUPPLIES", price: 706, lastPrice: 706, held: 0, avgBuyPrice: 0, volatility: 0.05, availableShares: 181, history: [] },
            "FLT": { name: "FLUTONIUM", price: 200, lastPrice: 200, held: 0, avgBuyPrice: 0, volatility: 0.15, availableShares: 359, history: [] },
            "JLB": { name: "JELLY BEANS", price: 19, lastPrice: 19, held: 0, avgBuyPrice: 0, volatility: 0.03, availableShares: 11, history: [] },
            "NTC": { name: "NANOTECH", price: 71, lastPrice: 71, held: 0, avgBuyPrice: 0, volatility: 0.10, availableShares: 172, history: [] },
            "SFL": { name: "8_FUEL", price: 1405.2, lastPrice: 1405.2, held: 0, avgBuyPrice: 0, volatility: 0.20, availableShares: 273, history: [] },
            "FCS": { name: "FOSITRONICS", price: 1394, lastPrice: 1394, held: 0, avgBuyPrice: 0, volatility: 0.18, availableShares: 260, history: [] },
            "FRT": { name: "FERTILISER", price: 264, lastPrice: 264, held: 0, avgBuyPrice: 0, volatility: 0.07, availableShares: 296, history: [] },
            "DMS": { name: "DIAMONDS", price: 1784, lastPrice: 1784, held: 0, avgBuyPrice: 0, volatility: 0.25, availableShares: 143, history: [] },
            "LAS": { name: "LIGHT ARMS", price: 1697, lastPrice: 1697, held: 0, avgBuyPrice: 0, volatility: 0.22, availableShares: 417, history: [] },
            "OCS": { name: "OPTRONICS", price: 1869, lastPrice: 1869, held: 0, avgBuyPrice: 0, volatility: 0.28, availableShares: 28, history: [] },
            "OXY": { name: "OXYGEN", price: 2295, lastPrice: 2295, held: 0, avgBuyPrice: 0, volatility: 0.10, availableShares: 251, history: [] },
            "TWE": { name: "TOXIC WASTE", price: 2611, lastPrice: 2611, held: 0, avgBuyPrice: 0, volatility: 0.30, availableShares: 210, history: [] },
            "PLY": { name: "POLYMERS", price: 2611, lastPrice: 2611, held: 0, avgBuyPrice: 0, volatility: 0.12, availableShares: 358, history: [] },
            "PCT": { name: "PHARMACEUTICALS", price: 2928, lastPrice: 2928, held: 0, avgBuyPrice: 0, volatility: 0.15, availableShares: 99, history: [] },
            "BBN": { name: "BOBON", price: 1012, lastPrice: 1012, held: 0, avgBuyPrice: 0, volatility: 0.09, availableShares: 327, history: [] },
            "PLT": { name: "PLATINUM", price: 3197, lastPrice: 3197, held: 0, avgBuyPrice: 0, volatility: 0.20, availableShares: 327, history: [] }
        };


        let commandHistory = []; // Stores past commands and their results for the command history panel
        let marketHistory = []; // Stores average market prices for the chart
        const chartHistoryLength = 15; // Number of data points to show in charts

        let selectedStockSymbol = null; // New: To keep track of the currently selected stock for buy/sell buttons

        // --- DOM Elements ---
        const mainMenu = document.getElementById('main-menu');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const gameOverMessage = document.getElementById('game-over-message');
        const startGameButton = document.getElementById('start-game-button');
        const mainMenuHelpButton = document.getElementById('main-menu-help-button');
        const restartGameButton = document.getElementById('restart-game-button');

        const fundsDisplay = document.getElementById('funds-display');
        const assetsDisplay = document.getElementById('assets-display');
        const timeDisplay = document.getElementById('time-display');
        const stockTableContainer = document.getElementById('stock-table-container');
        const logArea = document.getElementById('log-area');
        const commandHistoryElement = document.getElementById('command-history');
        const commandInput = document.getElementById('command-input');
        const enterButton = document.getElementById('enter-button');
        const marketChartCanvas = document.getElementById('market-chart');
        const marketChartContext = marketChartCanvas.getContext('2d');
        const chartTitleElement = document.getElementById('chart-title');

        const stockActionButtonsDiv = document.getElementById('stock-action-buttons');
        const buy1Button = document.getElementById('buy-1-button');
        const buy10Button = document.getElementById('buy-10-button');
        const buyMaxButton = document.getElementById('buy-max-button');
        const sell1Button = document.getElementById('sell-1-button');
        const sell10Button = document.getElementById('sell-10-button');
        const sellAllButton = document.getElementById('sell-all-button');
        const panicSellAllButton = document.getElementById('panic-sell-all-button');

        // New: Help Modal elements
        const helpModalOverlay = document.getElementById('help-modal-overlay');
        const helpModalCloseButton = document.getElementById('help-modal-close-button');
        const helpModalText = document.getElementById('help-modal-text');


        // --- Game State Management ---
        const GAME_STATE = {
            MENU: 'MENU',
            PLAYING: 'PLAYING',
            GAME_OVER: 'GAME_OVER',
            PAUSED: 'PAUSED' // New state for when a modal is open
        };
        let currentGameState = GAME_STATE.MENU;

        /**
         * Updates the visibility of different UI screens based on the current game state.
         */
        function updateUIForState() {
            mainMenu.classList.add('hidden');
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            stockActionButtonsDiv.classList.add('hidden'); // Always hide action buttons by default
            helpModalOverlay.classList.add('hidden'); // Always hide modal by default

            switch (currentGameState) {
                case GAME_STATE.MENU:
                    mainMenu.classList.remove('hidden');
                    commandInput.disabled = true;
                    enterButton.disabled = true;
                    break;
                case GAME_STATE.PLAYING:
                    gameScreen.classList.remove('hidden');
                    // Enable/disable input and buttons based on grace period
                    const inGracePeriod = timeLeft > gameDurationSeconds;
                    commandInput.disabled = inGracePeriod;
                    enterButton.disabled = inGracePeriod;
                    commandInput.focus();
                    if (!inGracePeriod) { // Only show action buttons after grace period
                        if (selectedStockSymbol) {
                            showStockActions();
                        } else {
                            stockActionButtonsDiv.classList.remove('hidden'); // Ensure div is visible for panic button
                            panicSellAllButton.disabled = calculateTotalSharesHeld() === 0;
                        }
                    }
                    break;
                case GAME_STATE.GAME_OVER:
                    gameOverScreen.classList.remove('hidden');
                    commandInput.disabled = true;
                    enterButton.disabled = true;
                    break;
                case GAME_STATE.PAUSED: // When a modal is open, show game screen but disable inputs
                    gameScreen.classList.remove('hidden');
                    commandInput.disabled = true;
                    enterButton.disabled = true;
                    stockActionButtonsDiv.classList.add('hidden'); // Hide trading buttons when paused
                    helpModalOverlay.classList.remove('hidden'); // Show the help modal
                    break;
            }
        }

        // --- Utility Functions ---

        /**
         * Appends a line of text to the game log area and scrolls to the bottom.
         * @param {string} text - The text string to display in the log.
         */
        function printToLog(text) {
            logArea.innerHTML += text + '\n';
            logArea.scrollTop = logArea.scrollHeight;
        }

        /**
         * Appends a command and its output to the command history area.
         * @param {string} command - The command entered by the user.
         * @param {string} output - The immediate output/response to the command.
         */
        function printToCommandHistory(command, output = '') {
            commandHistory.push(`C:\\DOS_TRADE>${command}`);
            if (output) {
                commandHistory.push(output);
            }
            // Keep history limited to prevent excessive scrolling, e.g., last 20 lines
            while (commandHistory.length > 20) {
                commandHistory.shift();
            }
            commandHistoryElement.innerHTML = commandHistory.join('\n');
            commandHistoryElement.scrollTop = commandHistoryElement.scrollHeight;
        }

        /**
         * Clears all text from the console output area.
         */
        function clearAllDisplays() {
            logArea.innerHTML = '';
            commandHistory = [];
            commandHistoryElement.innerHTML = '';
        }

        /**
         * Formats a numerical amount into a currency string (e.g., $1000.00).
         * @param {number} amount - The numerical amount to format.
         * @returns {string} - The formatted currency string.
         */
        function formatCurrency(amount) {
            return `$${amount.toFixed(2)}`;
        }

        /**
         * Formats seconds into a MM:SS string.
         * @param {number} totalSeconds - The total number of seconds.
         * @returns {string} - The formatted time string.
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        /**
         * Generates a random market event that can influence stock prices.
         * Each event has a message and an impact (either a general multiplier or stock-specific impacts).
         * @returns {{message: string, impact: number|Object}} - An object containing the event message and its impact.
         */
        function generateMarketEvent() {
            const events = [
                { message: "Global market experiences a slight upswing.", impact: 0.03 },
                { message: "Economic uncertainty causes a minor market dip.", impact: -0.03 },
                { message: "Tech sector innovation drives WTK prices up!", impact: { WTK: 0.2, default: 0.01 } },
                { message: "New synthetic materials impact PLS demand. PLS stock falls!", impact: { PLS: -0.15, default: -0.01 } },
                { message: "Rare KQU crop yield announced! KQU stock jumps.", impact: { KQU: 0.18, default: 0.01 } },
                { message: "New gold discovery in asteroid belt! GOL stock rockets!", impact: { GOL: 0.28, default: 0.02 } },
                { message: "Supply chain issues for OFS. OFS stock wavers.", impact: { OFS: -0.1, default: 0.00 } },
                { message: "FLT energy source proves unstable. FLT stock struggles.", impact: { FLT: -0.08, default: 0.00 } },
                { message: "Minor market fluctuations. No significant news.", impact: 0 },
                { message: "Unexpected geopolitical tensions. Market volatility increases!", impact: (Math.random() > 0.5 ? 0.05 : -0.05) },
                { message: "Positive economic indicators released. Broad market rally!", impact: 0.04 },
                { message: "Major corporation declares bankruptcy. Market fear spreads!", impact: -0.06 }
            ];
            const randomIndex = Math.floor(Math.random() * events.length);
            return events[randomIndex];
        }

        /**
         * Updates the price of each stock based on its volatility and the current market event.
         * Prices are clamped to a minimum of $1 to prevent negative values.
         * @param {{message: string, impact: number|Object}} event - The market event object.
         * @param {boolean} isInitialSimulation - True if this is part of initial trend generation.
         */
        function updateStockPrices(event, isInitialSimulation = false) {
            for (const symbol in stocks) {
                const stock = stocks[symbol];
                stock.lastPrice = stock.price; // Store current price as last price for comparison

                let priceChange = (Math.random() * 2 - 1) * stock.volatility;

                if (typeof event.impact === 'number') {
                    priceChange += event.impact;
                } else if (typeof event.impact === 'object') {
                    priceChange += event.impact[symbol] || event.impact.default || 0;
                }

                stock.price *= (1 + priceChange);
                stock.price = Math.max(1, stock.price); // Ensure price doesn't go below $1

                // Only add to history if not initial simulation (to avoid double-adding on game start)
                if (!isInitialSimulation) {
                    stock.history.push(stock.price);
                    if (stock.history.length > chartHistoryLength) {
                        stock.history.shift(); // Keep history limited
                    }
                }
            }
        }

        /**
         * Calculates the total value of all held stocks.
         * @returns {number} - The total market value of the player's portfolio.
         */
        function calculatePortfolioValue() {
            let value = 0;
            for (const symbol in stocks) {
                value += stocks[symbol].held * stocks[symbol].price;
            }
            return value;
        }

        /**
         * Calculates the total number of shares currently held by the player.
         * @returns {number} - The total count of shares across all stocks.
         */
        function calculateTotalSharesHeld() {
            let total = 0;
            for (const symbol in stocks) {
                total += stocks[symbol].held;
            }
            return total;
        }

        /**
         * Calculates the average price of all stocks to represent a market index.
         * @returns {number} - The average price of all available stocks.
         */
        function calculateMarketIndex() {
            let total = 0;
            let count = 0;
            for (const symbol in stocks) {
                total += stocks[symbol].price;
                count++;
            }
            return count > 0 ? total / count : 0;
        }

        /**
         * Draws a bar chart on the canvas. Can draw either the overall market index or a specific stock's trend.
         * @param {string} [stockSymbol] - Optional. If provided, draws the chart for this stock's history.
         * Otherwise, draws the overall market index history.
         */
        function drawChart(stockSymbol = null) {
            const canvas = marketChartCanvas;
            const ctx = marketChartContext;
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height); // Clear canvas

            let dataToChart = [];
            let chartLabel = '';

            if (stockSymbol && stocks[stockSymbol]) {
                dataToChart = stocks[stockSymbol].history;
                chartLabel = `${stocks[stockSymbol].name.toUpperCase()} (${stockSymbol}) TREND`;
            } else {
                dataToChart = marketHistory;
                chartLabel = `MARKET INDEX TREND`;
            }

            chartTitleElement.textContent = chartLabel;

            if (dataToChart.length === 0) {
                ctx.fillStyle = '#FFA500';
                ctx.font = '10px "Press Start 2P"';
                ctx.fillText("NO DATA", width / 2 - 30, height / 2);
                return;
            }

            const barWidth = width / dataToChart.length;
            const maxVal = Math.max(...dataToChart) * 1.1; // 10% buffer for max value
            const minVal = Math.min(...dataToChart) * 0.9; // 10% buffer for min value
            const range = maxVal - minVal;

            ctx.fillStyle = '#FFA500'; // Amber color for bars
            for (let i = 0; i < dataToChart.length; i++) {
                const value = dataToChart[i];
                // Scale value to canvas height
                const barHeight = (value - minVal) / range * height;
                ctx.fillRect(i * barWidth, height - barHeight, barWidth * 0.8, barHeight); // Draw bar
            }

            // Draw baseline
            ctx.strokeStyle = 'rgba(255, 165, 0, 0.5)';
            ctx.beginPath();
            ctx.moveTo(0, height);
            ctx.lineTo(width, height);
            ctx.stroke();
        }

        /**
         * Displays the current game status across all relevant display areas.
         * This is the main display update function.
         */
        function displayStatus() {
            // Update top bar stats
            fundsDisplay.textContent = `FUNDS: ${formatCurrency(playerMoney)}`;
            const totalAssets = playerMoney + calculatePortfolioValue();
            assetsDisplay.textContent = `TOTAL ASSETS: ${formatCurrency(totalAssets)}`;

            // Handle grace period time display
            if (timeLeft > gameDurationSeconds) {
                const countdown = timeLeft - gameDurationSeconds;
                timeDisplay.textContent = `STARTING IN: ${countdown}`;
                if (countdown === 0) {
                    printToLog("GO!!!");
                    timeDisplay.textContent = `TIME: ${formatTime(0)}`; // Show 00:00 for a moment before actual game time starts
                }
            } else {
                timeDisplay.textContent = `TIME: ${formatTime(timeLeft)}`;
            }


            // Build and display the stock table
            let tableHTML = `<table id="stock-table">`;
            tableHTML += `<thead><tr><th>PRODUCT</th><th>CODE</th><th>PRICE</th><th>AVAIL</th><th>OWNED</th><th>BOUGHT AT</th><th>PROFIT</th></tr></thead><tbody>`;

            for (const symbol in stocks) {
                const stock = stocks[symbol];
                const profit = stock.held > 0 ? (stock.price - stock.avgBuyPrice) * stock.held : 0;
                const profitColor = profit >= 0 ? '#FFA500' : '#FF0000'; // Amber for profit, Red for loss

                let priceClass = '';
                if (stock.price > stock.lastPrice) {
                    priceClass = 'price-up';
                } else if (stock.price < stock.lastPrice) {
                    priceClass = 'price-down';
                }

                // Add onclick event to each table row for showing stock trends and action buttons
                tableHTML += `<tr onclick="selectStock('${symbol}')">`;
                tableHTML += `<td>${stock.name}</td>`;
                tableHTML += `<td>${symbol}</td>`;
                tableHTML += `<td class="${priceClass}">${formatCurrency(stock.price)}</td>`; // Apply price change class
                tableHTML += `<td>${stock.availableShares}</td>`;
                tableHTML += `<td>${stock.held}</td>`;
                tableHTML += `<td>${stock.held > 0 ? formatCurrency(stock.avgBuyPrice) : 'N/A'}</td>`;
                tableHTML += `<td style="color: ${profitColor};">${formatCurrency(profit)}</td>`;
                tableHTML += `</tr>`;
            }
            tableHTML += `</tbody></table>`;
            stockTableContainer.innerHTML = tableHTML;
        }

        /**
         * Selects a stock, displays its trend, and shows the buy/sell action buttons.
         * Made globally accessible for onclick events.
         * @param {string} symbol - The symbol of the stock to select.
         */
        window.selectStock = function(symbol) {
            if (currentGameState !== GAME_STATE.PLAYING || timeLeft > gameDurationSeconds) return; // Only allow selection during play and after grace period

            selectedStockSymbol = symbol;
            showStockTrend(symbol); // Show the trend for the selected stock
            showStockActions(); // Show the buy/sell buttons for the selected stock
            commandInput.focus(); // Keep focus on the input field
        };

        /**
         * Displays the trend for a specific stock.
         * @param {string} symbol - The symbol of the stock to display the trend for.
         */
        function showStockTrend(symbol) {
            if (stocks[symbol]) {
                drawChart(symbol);
                printToLog(`Displaying trend for ${stocks[symbol].name} (${symbol}).`);
            } else {
                printToLog(`ERROR: Could not find trend data for ${symbol}.`);
            }
        }

        /**
         * Shows the buy/sell action buttons for the currently selected stock.
         * Updates button text to reflect the selected stock.
         */
        function showStockActions() {
            const inGracePeriod = timeLeft > gameDurationSeconds;

            // Hide all specific stock action buttons if no stock is selected OR in grace period
            if (!selectedStockSymbol || inGracePeriod) {
                buy1Button.classList.add('hidden');
                buy10Button.classList.add('hidden');
                buyMaxButton.classList.add('hidden');
                sell1Button.classList.add('hidden');
                sell10Button.classList.add('hidden');
                sellAllButton.classList.add('hidden');
                // Only show stock action buttons div if not in grace period and there are shares to sell (for panic button)
                if (!inGracePeriod && calculateTotalSharesHeld() > 0) {
                    stockActionButtonsDiv.classList.remove('hidden');
                } else {
                    stockActionButtonsDiv.classList.add('hidden');
                }
                panicSellAllButton.disabled = calculateTotalSharesHeld() === 0; // Panic button is always visible if not hidden by parent div
                return;
            }

            // If a stock is selected and not in grace period, show all buttons
            stockActionButtonsDiv.classList.remove('hidden');
            buy1Button.classList.remove('hidden');
            buy10Button.classList.remove('hidden');
            buyMaxButton.classList.remove('hidden');
            sell1Button.classList.remove('hidden');
            sell10Button.classList.remove('hidden');
            sellAllButton.classList.remove('hidden');


            const stock = stocks[selectedStockSymbol];

            // Update button labels with the selected stock's code
            buy1Button.textContent = `BUY 1 ${selectedStockSymbol}`;
            buy10Button.textContent = `BUY 10 ${selectedStockSymbol}`;
            sell1Button.textContent = `SELL 1 ${selectedStockSymbol}`;
            sell10Button.textContent = `SELL 10 ${selectedStockSymbol}`;

            // Calculate max buyable shares (only by money and available shares)
            const maxBuyableByMoney = Math.floor(playerMoney / stock.price);
            const maxBuyable = Math.min(maxBuyableByMoney, stock.availableShares);
            buyMaxButton.textContent = `BUY MAX (${maxBuyable}) ${selectedStockSymbol}`;
            buyMaxButton.disabled = maxBuyable <= 0; // Disable if cannot buy any

            // Calculate max sellable shares for the selected stock
            const maxSellableSelected = stock.held;
            sellAllButton.textContent = `SELL ALL (${maxSellableSelected}) ${selectedStockSymbol}`;
            sellAllButton.disabled = maxSellableSelected <= 0; // Disable if no shares of this stock held

            // Enable/disable Panic Sell All button based on total shares
            panicSellAllButton.disabled = calculateTotalSharesHeld() === 0;
        }

        /**
         * Hides the buy/sell action buttons.
         */
        function hideStockActions() {
            stockActionButtonsDiv.classList.add('hidden');
            selectedStockSymbol = null; // Clear selected stock
        }


        /**
         * Processes a user command entered into the input field.
         * Parses the command and calls the appropriate handler function.
         * @param {string} commandLine - The raw command string from the user.
         */
        function processCommand(commandLine) {
            if (timeLeft > gameDurationSeconds) { // If in grace period, do not process commands
                printToLog("Please wait for the game to start!");
                commandInput.value = '';
                return;
            }

            printToCommandHistory(commandLine); // Add command to history immediately
            const parts = commandLine.trim().toUpperCase().split(' ');
            const command = parts[0];

            let commandOutput = ''; // To capture the immediate output of the command

            switch (command) {
                case 'BUY':
                    commandOutput = handleBuy(parts[1], parseInt(parts[2]));
                    break;
                case 'SELL':
                    commandOutput = handleSell(parts[1], parseInt(parts[2]));
                    break;
                case 'HELP':
                    commandOutput = displayHelpContent(); // Call function to get help text
                    printToLog(commandOutput); // Print to log as a command output
                    break;
                case 'CLEAR':
                    clearAllDisplays(); // Clear all display areas
                    commandOutput = "Console cleared.";
                    break;
                case 'CHART':
                    // If CHART is called with a symbol, show that stock's chart. Otherwise, show market index.
                    commandOutput = displayChartForStock(parts[1]);
                    break;
                case 'RESTART': // New: Handle RESTART command
                    startGame(); // Call startGame to reset and begin a new game
                    commandOutput = "Game restarted.";
                    break;
                default:
                    commandOutput = `ERROR: Unknown command '${command}'. Type HELP for commands.`;
                    break;
            }
            if (commandOutput) {
                printToCommandHistory('', commandOutput); // Add command output to history
            }
            commandInput.value = ''; // Clear the input field after processing
            commandInput.focus(); // Keep focus on the input field
            displayStatus(); // Always refresh status after a command
            showStockActions(); // Re-evaluate and show/hide stock action buttons
        }

        /**
         * Handles the 'BUY' command logic.
         * Validates input, checks money/availability, and updates player's money and stock holdings.
         * @param {string} symbol - The stock symbol to buy.
         * @param {number} amount - The number of shares to buy.
         * @returns {string} - A message indicating the result of the buy operation.
         */
        function handleBuy(symbol, amount) {
            if (!symbol || !stocks[symbol]) {
                return `ERROR: Invalid stock symbol '${symbol}'.`;
            }
            if (isNaN(amount) || amount <= 0) {
                return `ERROR: Invalid amount for BUY. Must be a positive number.`;
            }

            const stock = stocks[symbol];
            const cost = stock.price * amount;

            if (playerMoney < cost) {
                return `ERROR: Not enough money. You need ${formatCurrency(cost)}, but have ${formatCurrency(playerMoney)}.`;
            }
            if (stock.availableShares < amount) {
                return `ERROR: Only ${stock.availableShares} shares of ${stock.name} are available.`;
            }

            // Update average buy price (weighted average)
            if (stock.held > 0) {
                stock.avgBuyPrice = ((stock.avgBuyPrice * stock.held) + (stock.price * amount)) / (stock.held + amount);
            } else {
                stock.avgBuyPrice = stock.price;
            }

            playerMoney -= cost;
            stock.held += amount;
            stock.availableShares -= amount;

            printToLog(`TRANSACTION COMPLETE: BOUGHT ${amount} shares of ${stock.name} for ${formatCurrency(cost)}.`);
            return `BOUGHT ${amount} shares of ${stock.name}.`;
        }

        /**
         * Handles the 'SELL' command logic.
         * Validates input, checks shares held, and updates player's money and stock holdings.
         * @param {string} symbol - The stock symbol to sell.
         * @param {number} amount - The number of shares to sell.
         * @returns {string} - A message indicating the result of the sell operation.
         */
        function handleSell(symbol, amount) {
            if (!symbol || !stocks[symbol]) {
                return `ERROR: Invalid stock symbol '${symbol}'.`;
            }
            if (isNaN(amount) || amount <= 0) {
                return `ERROR: Invalid amount for SELL. Must be a positive number.`;
            }

            const stock = stocks[symbol];
            if (stock.held < amount) {
                return `ERROR: You only hold ${stock.held} shares of ${stock.name}. Cannot sell ${amount}.`;
            }

            const revenue = stock.price * amount;
            playerMoney += revenue;
            stock.held -= amount;
            stock.availableShares += amount;

            // If all shares are sold, reset average buy price
            if (stock.held === 0) {
                stock.avgBuyPrice = 0;
            }

            printToLog(`TRANSACTION COMPLETE: SOLD ${amount} shares of ${stock.name} for ${formatCurrency(revenue)}.`);
            return `SOLD ${amount} shares of ${stock.name}.`;
        }

        /**
         * The main game loop function, called at regular intervals.
         * Updates time, stock prices, checks for market events, and updates display.
         */
        function gameLoop() {
            // Only run game logic if not paused
            if (currentGameState === GAME_STATE.PAUSED) {
                return;
            }

            timeLeft--;
            if (timeLeft < 0) {
                timeLeft = 0; // Ensure time doesn't go negative on display
            }

            const inGracePeriod = timeLeft > gameDurationSeconds;

            if (!inGracePeriod) { // Only update prices and generate events after grace period
                // Generate a market event based on probability
                let currentEvent = { message: "Market remains stable.", impact: 0 }; // Default no-impact event
                if (Math.random() < eventChancePerInterval) {
                    currentEvent = generateMarketEvent();
                    printToLog(`\nMARKET NEWS: ${currentEvent.message}`);
                }

                updateStockPrices(currentEvent); // Update prices based on event or default

                // Update market index history for the overall chart
                const marketIndex = calculateMarketIndex();
                marketHistory.push(marketIndex);
                if (marketHistory.length > chartHistoryLength) {
                    marketHistory.shift();
                }
            } else if (timeLeft === gameDurationSeconds) { // Exactly at the end of grace period
                printToLog("GO!!!"); // Signal the start of trading
            }

            displayStatus(); // Refresh all display elements
            updateUIForState(); // Update UI elements like button disabled states based on grace period
            drawChart(selectedStockSymbol); // Redraw chart (either selected stock or market index)


            // Check for game over conditions (only after grace period)
            if (!inGracePeriod) {
                const totalAssets = playerMoney + calculatePortfolioValue();
                if (totalAssets >= targetMoney) {
                    endGame(true); // Win condition met
                } else if (playerMoney <= 0 && calculatePortfolioValue() <= 0) {
                    endGame(false, "YOU WENT BANKRUPT!"); // Bankruptcy
                } else if (timeLeft <= 0) {
                    endGame(false, "TIME RAN OUT!"); // Time ran out
                }
            }
        }

        /**
         * Returns the help message content.
         * @returns {string} - The help message.
         */
        function displayHelpContent() {
            return `--- GAME GOAL ---
  Your mission: Make ${formatCurrency(targetMoney)} or more in total assets in ${formatTime(gameDurationSeconds)}!
  There is a ${gracePeriodSeconds}-second grace period at the start to get ready.
  You can also type 'RESTART' at any time to begin a new game.
  Good luck, trader!`;
        }

        /**
         * Handles the CHART command. Displays either the overall market trend or a specific stock's trend.
         * @param {string} [symbol] - Optional. The stock symbol to chart.
         * @returns {string} - A message indicating chart action.
         */
        function displayChartForStock(symbol) {
            if (symbol && stocks[symbol]) {
                drawChart(symbol);
                return `Displaying trend for ${stocks[symbol].name} (${symbol}).`;
            } else {
                drawChart(); // Draw market index if no valid symbol provided
                return `Displaying overall market trend.`;
            }
        }

        /**
         * Ends the game, displaying a win or loss message.
         * Stops the game loop and disables input.
         * @param {boolean} [won=false] - Optional: True if the player won, false otherwise.
         * @param {string} [reason=""] - Optional: Specific reason for game over (e.g., "TIME RAN OUT!").
         */
        function endGame(won = false, reason = "") {
            clearInterval(gameInterval); // Stop the real-time game loop
            currentGameState = GAME_STATE.GAME_OVER;
            updateUIForState(); // Show game over screen

            let message = "";
            const finalAssets = playerMoney + calculatePortfolioValue();

            if (won) {
                message = `CONGRATULATIONS! You reached ${formatCurrency(finalAssets)} and surpassed your goal of ${formatCurrency(targetMoney)}!\nYou are a MASTER TRADER!`;
            } else {
                message = `You ended with ${formatCurrency(finalAssets)} in total assets.\nYou needed ${formatCurrency(targetMoney)} or more to win.\n`;
                if (reason) {
                    message += `${reason}\n`;
                }
                message += `BETTER LUCK NEXT TIME, ROOKIE.`;
            }
            gameOverMessage.textContent = message;
        }

        /**
         * Resets game state and starts a new game.
         */
        function resetGame() {
            playerMoney = 1000;
            timeLeft = gameDurationSeconds + gracePeriodSeconds; // Reset time including grace period
            selectedStockSymbol = null; // Clear selected stock

            // Reset stock data to initial values and clear history
            const initialStockStates = { // Define initial states to reset to
                "WTK": { name: "MATER", price: 36, lastPrice: 36, held: 0, avgBuyPrice: 0, volatility: 0.08, availableShares: 153, history: [] },
                "PLS": { name: "PLASTICS", price: 161, lastPrice: 161, held: 0, avgBuyPrice: 0, volatility: 0.04, availableShares: 335, history: [] },
                "KQU": { name: "KUMQUATS", price: 348, lastPrice: 348, held: 0, avgBuyPrice: 0, volatility: 0.12, availableShares: 219, history: [] },
                "GOL": { name: "GOLD", price: 398, lastPrice: 398, held: 0, avgBuyPrice: 0, volatility: 0.06, availableShares: 129, history: [] },
                "OFS": { name: "OFFICE SUPPLIES", price: 706, lastPrice: 706, held: 0, avgBuyPrice: 0, volatility: 0.05, availableShares: 181, history: [] },
                "FLT": { name: "FLUTONIUM", price: 200, lastPrice: 200, held: 0, avgBuyPrice: 0, volatility: 0.15, availableShares: 359, history: [] },
                "JLB": { name: "JELLY BEANS", price: 19, lastPrice: 19, held: 0, avgBuyPrice: 0, volatility: 0.03, availableShares: 11, history: [] },
                "NTC": { name: "NANOTECH", price: 71, lastPrice: 71, held: 0, avgBuyPrice: 0, volatility: 0.10, availableShares: 172, history: [] },
                "SFL": { name: "8_FUEL", price: 1405.2, lastPrice: 1405.2, held: 0, avgBuyPrice: 0, volatility: 0.20, availableShares: 273, history: [] },
                "FCS": { name: "FOSITRONICS", price: 1394, lastPrice: 1394, held: 0, avgBuyPrice: 0, volatility: 0.18, availableShares: 260, history: [] },
                "FRT": { name: "FERTILISER", price: 264, lastPrice: 264, held: 0, avgBuyPrice: 0, volatility: 0.07, availableShares: 296, history: [] },
                "DMS": { name: "DIAMONDS", price: 1784, lastPrice: 1784, held: 0, avgBuyPrice: 0, volatility: 0.25, availableShares: 143, history: [] },
                "LAS": { name: "LIGHT ARMS", price: 1697, lastPrice: 1697, held: 0, avgBuyPrice: 0, volatility: 0.22, availableShares: 417, history: [] },
                "OCS": { name: "OPTRONICS", price: 1869, lastPrice: 1869, held: 0, avgBuyPrice: 0, volatility: 0.28, availableShares: 28, history: [] },
                "OXY": { name: "OXYGEN", price: 2295, lastPrice: 2295, held: 0, avgBuyPrice: 0, volatility: 0.10, availableShares: 251, history: [] },
                "TWE": { name: "TOXIC WASTE", price: 2611, lastPrice: 2611, held: 0, avgBuyPrice: 0, volatility: 0.30, availableShares: 210, history: [] },
                "PLY": { name: "POLYMERS", price: 2611, lastPrice: 2611, held: 0, avgBuyPrice: 0, volatility: 0.12, availableShares: 358, history: [] },
                "PCT": { name: "PHARMACEUTICALS", price: 2928, lastPrice: 2928, held: 0, avgBuyPrice: 0, volatility: 0.15, availableShares: 99, history: [] },
                "BBN": { name: "BOBON", price: 1012, lastPrice: 1012, held: 0, avgBuyPrice: 0, volatility: 0.09, availableShares: 327, history: [] },
                "PLT": { name: "PLATINUM", price: 3197, lastPrice: 3197, held: 0, avgBuyPrice: 0, volatility: 0.20, availableShares: 327, history: [] }
            };
            for (const symbol in stocks) {
                Object.assign(stocks[symbol], initialStockStates[symbol]); // Copy initial properties
                stocks[symbol].history = []; // Ensure history is an empty array
            }

            marketHistory = []; // Clear market history
            clearAllDisplays(); // Clear logs and command history
        }

        /**
         * Starts the game, resetting values and initiating the game loop.
         */
        function startGame() {
            resetGame(); // Reset all game variables
            simulateInitialTrends(); // Generate new initial trends for a fresh start

            // Populate initial market history for the chart
            for (let i = 0; i < chartHistoryLength; i++) {
                marketHistory.push(calculateMarketIndex() + (Math.random() * 10 - 5));
            }
            drawChart(); // Draw initial market index chart

            printToLog(`C:\\>_`);
            printToLog(`\nWelcome to DOS TRADE!`);
            printToLog(`Your mission: Make ${formatCurrency(targetMoney)} or more in total assets in ${formatTime(gameDurationSeconds)}!`);
            printToLog(`There is a ${gracePeriodSeconds}-second grace period to get ready.`);
            printToLog(`Click on a stock row to see its historical trend and use quick buy/sell buttons!`);
            displayStatus(); // Display initial game status

            currentGameState = GAME_STATE.PLAYING;
            updateUIForState(); // Switch to game screen and disable trading actions

            // Start the real-time game loop
            clearInterval(gameInterval); // Clear any existing interval
            gameInterval = setInterval(gameLoop, updateIntervalMs);
        }

        /**
         * Simulates initial stock price trends for each stock before the game starts.
         * This populates the 'history' array for each stock.
         */
        function simulateInitialTrends() {
            const initialDataPoints = chartHistoryLength; // Number of data points to simulate for initial history
            for (const symbol in stocks) {
                const stock = stocks[symbol];
                stock.history = []; // Reset history for a new game

                let tempPrice = stock.price; // Use a temporary price for simulation
                for (let i = 0; i < initialDataPoints; i++) {
                    const event = generateMarketEvent(); // Use a generic event
                    let priceChange = (Math.random() * 2 - 1) * stock.volatility;
                    if (typeof event.impact === 'number') {
                        priceChange += event.impact;
                    } else if (typeof event.impact === 'object') {
                        priceChange += event.impact[symbol] || event.impact.default || 0;
                    }
                    tempPrice *= (1 + priceChange);
                    tempPrice = Math.max(1, tempPrice);
                    stock.history.push(tempPrice);
                }
                // After simulation, ensure the current price for the game start is the actual initial price
                // and set lastPrice for initial visual comparison.
                stock.lastPrice = stock.price;
                stock.price = stocks[symbol].price; // Reset to original starting price for game
            }
        }

        // --- Event Listeners ---

        // Main Menu Buttons
        startGameButton.addEventListener('click', startGame);
        mainMenuHelpButton.addEventListener('click', () => {
            clearInterval(gameInterval); // Ensure game loop is stopped
            currentGameState = GAME_STATE.PAUSED; // Set state to PAUSED
            updateUIForState(); // Update UI to show game screen with disabled inputs and the modal
            clearAllDisplays(); // Clear logs
            helpModalText.textContent = displayHelpContent(); // Populate modal with help text
        });

        // Help Modal Close Button
        helpModalCloseButton.addEventListener('click', () => {
            helpModalOverlay.classList.add('hidden'); // Hide the modal
            // If the game was already playing (i.e., not from main menu help), resume it.
            // Otherwise, return to the main menu.
            if (timeLeft <= gameDurationSeconds) { // If game time has started (not in grace period or initial menu)
                currentGameState = GAME_STATE.PLAYING;
                gameInterval = setInterval(gameLoop, updateIntervalMs); // Resume game loop
            } else {
                currentGameState = GAME_STATE.MENU; // Go back to main menu
            }
            updateUIForState(); // Update UI based on new state
        });


        // Restart Game Button
        restartGameButton.addEventListener('click', startGame); // Restart calls startGame

        // Command Input Field
        commandInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && currentGameState === GAME_STATE.PLAYING) {
                processCommand(commandInput.value);
            }
        });

        // Enter Button
        enterButton.addEventListener('click', () => {
            if (currentGameState === GAME_STATE.PLAYING) {
                processCommand(commandInput.value);
            }
        });

        // Clickable Buy/Sell Buttons
        buy1Button.addEventListener('click', () => {
            if (selectedStockSymbol && currentGameState === GAME_STATE.PLAYING && timeLeft <= gameDurationSeconds) handleBuy(selectedStockSymbol, 1);
            displayStatus();
            showStockActions(); // Update buttons after transaction
            commandInput.focus();
        });
        buy10Button.addEventListener('click', () => {
            if (selectedStockSymbol && currentGameState === GAME_STATE.PLAYING && timeLeft <= gameDurationSeconds) handleBuy(selectedStockSymbol, 10);
            displayStatus();
            showStockActions();
            commandInput.focus();
        });
        buyMaxButton.addEventListener('click', () => {
            if (selectedStockSymbol && currentGameState === GAME_STATE.PLAYING && timeLeft <= gameDurationSeconds) {
                const stock = stocks[selectedStockSymbol];
                const maxBuyableByMoney = Math.floor(playerMoney / stock.price);
                const amount = Math.min(maxBuyableByMoney, stock.availableShares);
                handleBuy(selectedStockSymbol, amount); 
            }
            displayStatus();
            showStockActions();
            commandInput.focus();
        });

        sell1Button.addEventListener('click', () => {
            if (selectedStockSymbol && currentGameState === GAME_STATE.PLAYING && timeLeft <= gameDurationSeconds) handleSell(selectedStockSymbol, 1);
            displayStatus();
            showStockActions();
            commandInput.focus();
        });
        sell10Button.addEventListener('click', () => {
            if (selectedStockSymbol && currentGameState === GAME_STATE.PLAYING && timeLeft <= gameDurationSeconds) handleSell(selectedStockSymbol, 10);
            displayStatus();
            showStockActions();
            commandInput.focus();
        });
        sellAllButton.addEventListener('click', () => {
            if (selectedStockSymbol && currentGameState === GAME_STATE.PLAYING && timeLeft <= gameDurationSeconds) {
                const stock = stocks[selectedStockSymbol];
                handleSell(selectedStockSymbol, stock.held); // Sell all held shares
            }
            displayStatus();
            showStockActions();
            commandInput.focus();
        });

        // Panic Sell All Button
        panicSellAllButton.addEventListener('click', () => {
            if (currentGameState !== GAME_STATE.PLAYING || timeLeft > gameDurationSeconds) {
                printToLog("Cannot perform actions during grace period or if game is not active.");
                return;
            }
            if (calculateTotalSharesHeld() === 0) { // Check total shares held across all stocks
                printToLog("ERROR: No stocks to sell!");
                return;
            }
            printToLog("\n--- PANIC SELL INITIATED! ---");
            let totalSoldValue = 0;
            let totalSharesSold = 0;
            for (const symbol in stocks) {
                const stock = stocks[symbol];
                if (stock.held > 0) {
                    const revenue = stock.price * stock.held;
                    playerMoney += revenue;
                    totalSoldValue += revenue;
                    totalSharesSold += stock.held;
                    stock.held = 0; // Set held to 0
                    stock.availableShares += stock.held; // Return to available shares (though not strictly necessary for held=0)
                    stock.avgBuyPrice = 0; // Reset average buy price
                    printToLog(`SOLD ALL ${symbol} for ${formatCurrency(revenue)}.`);
                }
            }
            printToLog(`TOTAL PANIC SELL: ${totalSharesSold} shares for ${formatCurrency(totalSoldValue)}.`);
            displayStatus();
            hideStockActions(); // Hide specific stock actions as no stock is selected
            commandInput.focus();
        });


        // --- Initial Setup ---
        window.onload = function() {
            updateUIForState(); // Start in the menu state
        };
    </script>
</body>
</html>
